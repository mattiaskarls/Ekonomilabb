---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { slugifyTag } from "../../utils/slugify";

const resources = (await getCollection("resurser")).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

// Taggstatistik
const tagCounts = new Map<string, number>();

for (const r of resources) {
  const tags = (r.data.tags ?? [])
    .map((t) => (typeof t === "string" ? t.trim() : ""))
    .filter((t) => t.length > 0);

  for (const tag of tags) {
    tagCounts.set(tag, (tagCounts.get(tag) ?? 0) + 1);
  }
}

const allTags = Array.from(tagCounts.entries())
  .map(([tag, count]) => ({ tag, count }))
  .sort((a, b) => a.tag.localeCompare(b.tag, "sv"));

const counts = allTags.map((t) => t.count);
const maxCount = counts.length ? Math.max(...counts) : 1;
const minCount = counts.length ? Math.min(...counts) : 1;

function sizeClass(count: number) {
  const t =
    maxCount === minCount ? 0.5 : (count - minCount) / (maxCount - minCount);

  if (t >= 0.85) return "text-base md:text-lg";
  if (t >= 0.6) return "text-sm md:text-base";
  if (t >= 0.35) return "text-sm";
  return "text-xs md:text-sm";
}

const card =
  "rounded-2xl border border-[var(--border)] bg-[var(--surface)]/70 p-5 transition hover:border-[var(--gold)]/60";

const tagChip =
  "inline-flex items-center rounded-full border border-[var(--border)] bg-[var(--surface-soft)]/60 px-3 py-1 text-[var(--text-muted)] hover:text-[var(--gold)] hover:border-[var(--gold)] transition";

function typeBadge() {
  return "border border-[var(--border)] text-[var(--text-muted)] bg-[var(--surface-soft)]/60";
}
---

<BaseLayout title="Resurser – Ekonomismedjan">
  <!-- HEADER -->
  <header class="space-y-2 pb-8">
    <h1 class="text-2xl font-semibold">Resurser</h1>
    <p class="text-[var(--text-muted)] max-w-3xl">
      Böcker, tjänster och verktyg jag tycker är värda din tid – med korta, ärliga kommentarer.
    </p>
    <p class="text-xs text-[var(--text-muted)] max-w-3xl">
      Transparens: vissa länkar kan vara affiliatelänkar. Det kostar inte mer för dig men kan ge stöd till sidan.
    </p>
  </header>

  <!-- TAG CLOUD -->
  {allTags.length ? (
    <section class="rounded-2xl border border-[var(--border)] bg-[var(--surface)]/60 p-5 space-y-4 mb-10">
      <div class="flex items-center justify-between gap-4">
        <h2 class="text-sm font-semibold">Utforska via taggar</h2>
        <span class="text-xs text-[var(--text-muted)]">
          {allTags.length} taggar
        </span>
      </div>

      <div class="flex flex-wrap gap-2">
        {allTags.map(({ tag, count }) => (
          <a
            href={`/resurser/tagg/${slugifyTag(tag)}/`}
            class={`${tagChip} ${sizeClass(count)}`}
            title={`${count} resurser`}
          >
            #{tag}
            <span class="ml-2 text-[10px] md:text-xs text-[var(--text-muted)]">
              {count}
            </span>
          </a>
        ))}
      </div>

      <p class="text-xs text-[var(--text-muted)]">
        Större tagg = vanligare tema.
      </p>
    </section>
  ) : null}

  <!-- RESOURCES -->
  <section class="grid gap-5 md:grid-cols-2">
    {resources.map((r) => (
      <article class={card}>
        <div class="flex gap-4">
          <img
            src={r.data.coverImage}
            alt={`Omslag/logotyp: ${r.data.title}`}
            class="h-16 w-16 rounded-xl border border-[var(--border)] bg-[var(--surface-soft)]/40 object-cover"
            loading="lazy"
          />

          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-2 flex-wrap">
              <span
                class={`inline-flex items-center justify-center rounded-full px-2 py-0.5 text-[11px] ${typeBadge()}`}
              >
                {r.data.type}
              </span>

              {r.data.featured ? (
                <span class="inline-flex items-center justify-center rounded-full border border-[var(--gold)]/60 px-2 py-0.5 text-[11px] text-[var(--gold)]">
                  Utvald
                </span>
              ) : null}

              <span class="text-[11px] text-[var(--text-muted)]">
                {r.data.date.toLocaleDateString("sv-SE")}
              </span>
            </div>

            <a
              href={`/resurser/${r.slug}/`}
              class="block mt-2 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--focus)]"
              aria-label={`Öppna resurs: ${r.data.title}`}
            >
              <h2 class="text-lg font-semibold hover:text-[var(--gold)] transition truncate">
                {r.data.title}
              </h2>

              <p class="text-sm text-[var(--text)]/90 mt-1 line-clamp-3">
                {r.data.excerpt}
              </p>
            </a>

            {r.data.tags?.length ? (
              <div class="mt-3 flex gap-2 flex-wrap">
                {r.data.tags
                  .map((t) => (typeof t === "string" ? t.trim() : ""))
                  .filter((t) => t.length > 0)
                  .map((tag) => (
                    <a
                      href={`/resurser/tagg/${slugifyTag(tag)}/`}
                      class="text-xs px-2 py-1 rounded-full border border-[var(--border)] bg-[var(--surface-soft)]/60 text-[var(--text-muted)] hover:text-[var(--gold)] hover:border-[var(--gold)] transition"
                    >
                      #{tag}
                    </a>
                  ))}
              </div>
            ) : null}
          </div>
        </div>
      </article>
    ))}
  </section>
</BaseLayout>
