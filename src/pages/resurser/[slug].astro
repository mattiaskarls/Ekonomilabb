---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { slugifyTag } from "../../utils/slugify";

export async function getStaticPaths() {
  const resources = await getCollection("resurser");
  return resources.map((r) => ({
    params: { slug: r.slug },
    props: { resource: r },
  }));
}

const { resource } = Astro.props;
const { Content } = await resource.render();

// Robust canonical (funkar lokalt + prod)
const origin = Astro.site?.toString().replace(/\/$/, "") ?? Astro.url.origin;
const canonical = `${origin}/resurser/${resource.slug}/`;

const tags =
  (resource.data.tags ?? [])
    .map((t) => (typeof t === "string" ? t.trim() : ""))
    .filter((t) => t.length > 0);

const links = resource.data.links ?? [];
---

<BaseLayout
  title={resource.data.title}
  description={resource.data.excerpt}
  canonical={canonical}
>
  <slot name="head">
    <script type="application/ld+json">
      {JSON.stringify({
        "@context": "https://schema.org",
        "@type": "CreativeWork",
        name: resource.data.title,
        description: resource.data.excerpt,
        datePublished: resource.data.date,
        mainEntityOfPage: canonical,
        publisher: {
          "@type": "Organization",
          name: "EkonomiSmedjan",
        },
      })}
    </script>
  </slot>

  <main class="py-12 space-y-10">
    <!-- Breadcrumbs -->
    <nav aria-label="Brödsmulor" class="text-xs text-[var(--text-muted)]">
      <ol class="flex flex-wrap items-center gap-2">
        <li>
          <a href="/" class="hover:text-[var(--gold)] transition">Hem</a>
        </li>
        <li class="opacity-70">/</li>
        <li>
          <a href="/resurser/" class="hover:text-[var(--gold)] transition">Resurser</a>
        </li>
        <li class="opacity-70">/</li>
        <li class="text-[var(--text)] truncate max-w-[70vw]">
          {resource.data.title}
        </li>
      </ol>
    </nav>

    <!-- Rubrik / intro -->
    <header class="space-y-2">
      <h1 class="text-2xl md:text-3xl font-semibold">Resurser</h1>
      <p class="text-[var(--text-muted)] max-w-2xl">
        Böcker, tjänster och verktyg som hjälper dig lyckas med att smida din ekonomi.
      </p>
    </header>

    <!-- Själva resursen -->
    <section class="rounded-2xl border border-[var(--border)] bg-[var(--surface)] p-6 space-y-6">
      <div class="flex flex-col md:flex-row gap-6">
        {resource.data.coverImage ? (
          <!-- FIXAD BILDRUTA -->
          <div class="h-28 w-28 flex items-center justify-center rounded-2xl border border-[var(--border)] bg-[var(--surface-soft)]">
            <img
              src={resource.data.coverImage}
              alt={`Omslag/logotyp: ${resource.data.title}`}
              width="112"
              height="112"
              class="max-h-full max-w-full object-contain"
              loading="lazy"
            />
          </div>
        ) : null}

        <div class="min-w-0 flex-1 space-y-3">
          <h2 class="text-xl md:text-2xl font-semibold">
            {resource.data.title}
          </h2>

          {resource.data.excerpt ? (
            <p class="text-[var(--text)]/90">
              {resource.data.excerpt}
            </p>
          ) : null}

          {tags.length ? (
            <div class="flex flex-wrap gap-2 pt-1">
              {tags.map((tag) => (
                <a
                  href={`/resurser/tagg/${slugifyTag(tag)}/`}
                  class="text-xs px-2 py-1 rounded-full border border-[var(--border)] bg-[var(--surface-soft)] text-[var(--text-muted)] hover:text-[var(--gold)] hover:border-[var(--gold)] transition"
                >
                  #{tag}
                </a>
              ))}
            </div>
          ) : null}
        </div>
      </div>

      {links.length ? (
        <div class="flex flex-col sm:flex-row gap-3 pt-2">
          {links.map((l) => (
            <a
              href={l.url}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center rounded-xl bg-[var(--gold)] hover:bg-[var(--gold-hover)] text-black font-medium px-4 py-2 transition"
            >
              {l.label} →
            </a>
          ))}
        </div>
      ) : null}
    </section>

    <!-- Innehåll -->
<article class="prose prose-invert max-w-3xl">
  <Content />
</article>
  </main>
</BaseLayout>
