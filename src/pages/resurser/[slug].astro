---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { slugifyTag } from "../../utils/slugify";

export async function getStaticPaths() {
  const resources = await getCollection("resurser");
  return resources.map((r) => ({
    params: { slug: r.slug },
    props: { resource: r },
  }));
}

const { resource } = Astro.props;
const { Content } = await resource.render();

const tags =
  (resource.data.tags ?? [])
    .map((t) => (typeof t === "string" ? t.trim() : ""))
    .filter((t) => t.length > 0);

const links = resource.data.links ?? [];

function typeBadge() {
  return "border border-[var(--border)] bg-[var(--surface-soft)] text-[var(--text-muted)]";
}
---

<BaseLayout title={`${resource.data.title} – Resurser – Ekonomismedjan`}>
  <main class="max-w-4xl mx-auto px-4 py-10 space-y-8">
    <!-- Breadcrumbs + date -->
    <div class="flex items-center justify-between gap-4 flex-wrap">
      <nav aria-label="Brödsmulor" class="text-xs text-[var(--text-muted)]">
        <ol class="flex flex-wrap items-center gap-2">
          <li><a href="/" class="hover:text-[var(--gold)] transition">Hem</a></li>
          <li class="opacity-70">/</li>
          <li><a href="/resurser/" class="hover:text-[var(--gold)] transition">Resurser</a></li>
          <li class="opacity-70">/</li>
          <li class="text-[var(--text)] truncate max-w-[70vw]">{resource.data.title}</li>
        </ol>
      </nav>

      <span class="text-xs text-[var(--text-muted)]">
        {resource.data.date.toLocaleDateString("sv-SE")}
      </span>
    </div>

    <!-- Header card -->
    <header class="rounded-2xl border border-[var(--border)] bg-[var(--surface)] p-6">
      <div class="flex flex-col md:flex-row gap-6">
        <img
          src={resource.data.coverImage}
          alt={`Omslag/logotyp: ${resource.data.title}`}
          class="h-28 w-28 rounded-2xl border border-[var(--border)] bg-[var(--surface-soft)] object-cover"
          loading="lazy"
        />

        <div class="min-w-0 flex-1 space-y-3">
          <div class="flex items-center gap-2 flex-wrap">
            <span class={`inline-flex rounded-full px-3 py-1 text-xs ${typeBadge()}`}>
              {resource.data.type}
            </span>

            {resource.data.featured ? (
              <span class="inline-flex rounded-full border border-[var(--gold)] px-3 py-1 text-xs text-[var(--gold)]">
                Utvald
              </span>
            ) : null}

            {tags.length ? (
              <div class="flex flex-wrap gap-2">
                {tags.map((tag) => (
                  <a
                    href={`/resurser/tagg/${slugifyTag(tag)}/`}
                    class="text-xs px-2 py-1 rounded-full border border-[var(--border)] bg-[var(--surface-soft)] text-[var(--text-muted)] hover:text-[var(--gold)] hover:border-[var(--gold)] transition"
                  >
                    #{tag}
                  </a>
                ))}
              </div>
            ) : null}
          </div>

          <h1 class="text-2xl md:text-3xl font-semibold">{resource.data.title}</h1>
          <p class="text-[var(--text)]/90">{resource.data.excerpt}</p>

          <p class="text-xs text-[var(--text-muted)]">
            Transparens: vissa länkar kan vara affiliatelänkar.
          </p>
        </div>
      </div>
    </header>

    <!-- Links -->
    {links.length ? (
      <section class="rounded-2xl border border-[var(--border)] bg-[var(--surface)] p-5 space-y-3">
        <h2 class="text-sm font-semibold">Köp / läs mer</h2>

        <div class="flex flex-col sm:flex-row gap-3">
          {links.map((l) => (
            <a
              href={l.url}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center rounded-xl bg-[var(--gold)] hover:bg-[var(--gold-hover)] text-black font-medium px-4 py-2 transition"
            >
              {l.label} →
            </a>
          ))}
        </div>
      </section>
    ) : null}

    <!-- Content -->
    <article class="prose prose-invert max-w-none">
      <Content />
    </article>
  </main>
</BaseLayout>
